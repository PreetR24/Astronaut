<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astronaut Schedule CLI ðŸš€</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Courier New', monospace;
      padding: 20px;
      margin: 0;
    }
    #terminal-window {
      background-color: #000000;
      border: 1px solid #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
      overflow-y: auto;
      user-select: text;
    }
    .prompt {
      color: #00ff00; /* Green for prompt */
      display: inline;
    }
    #output-history {
      white-space: pre-wrap;
      user-select: text;
    }
    #input-line {
      display: flex;
      align-items: center;
    }
    #cmdInput {
      flex-grow: 1;
      background: none;
      border: none;
      color: #d4d4d4;
      font-family: inherit;
      font-size: inherit;
      outline: none;
    }
    .error {
      color: #ff4136; /* Red for errors */
    }
    .success {
      color: #7fdbff; /* Blue for success messages */
    }
    .welcome {
      color: #ffdc00; /* Yellow for welcome */
    }
  </style>
</head>
<body>
  <div id="terminal-window">
    <div id="output-history">
      <pre class="welcome">
      </pre>
      <p class="welcome">
        Welcome, Astronaut! Type 'help' to see available commands.
      </p>
    </div>
    <div id="input-line">
      <span class="prompt">astro-cli ></span>
      <input type="text" id="cmdInput" autofocus />
    </div>
  </div>

  <script>
  const input = document.getElementById('cmdInput');
  const historyDiv = document.getElementById('output-history');
  const terminalWindow = document.getElementById('terminal-window');

    // --- New Command History Variables ---
    const commandHistory = [];
    let historyIndex = -1; 
    // -------------------------------------

  /**
  * Parses a command string into a command and an array of arguments,
  * correctly handling quoted strings as single arguments.
  */
  function parseCommand(commandLine) {
    // Regex to split by space, but keep quoted strings intact.
    const regex = /[^\s"]+|"([^"]*)"/g;
    const parts = [];
    let match;
    while (match = regex.exec(commandLine)) {
      // Use captured group 1 if it exists (quoted string), otherwise use the full match.
      parts.push(match[1] ? match[1] : match[0]);
    }

    const cmd = parts.length > 0 ? parts[0] : '';
    const args = parts.slice(1);
    return { cmd, args };
  }

  // Initial focus on input
  input.focus();

    // --- Keydown Listener for History Navigation ---
    input.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp') {
            e.preventDefault(); // Prevent cursor movement
            if (commandHistory.length === 0) return;

            historyIndex = Math.max(0, historyIndex - 1);
            input.value = commandHistory[historyIndex];
            
        } else if (e.key === 'ArrowDown') {
            e.preventDefault(); // Prevent cursor movement
            if (commandHistory.length === 0) return;

            historyIndex = Math.min(commandHistory.length, historyIndex + 1);

            // If we go past the last command, clear the input
            if (historyIndex === commandHistory.length) {
                input.value = '';
            } else {
                input.value = commandHistory[historyIndex];
            }
        }
    });

  input.addEventListener('keydown', async (e) => {
   if (e.key === 'Enter') {
    const fullCommand = input.value.trim();
    
        // 1. Add command to history and reset index
        if (fullCommand) {
            commandHistory.push(fullCommand);
            historyIndex = commandHistory.length;
        }

    input.value = ''; // Clear input immediately
    
    // Add command to history display
    const commandLine = document.createElement('div');
    commandLine.innerHTML = `<span class="prompt">astro-cli ></span> ${fullCommand}`;
    historyDiv.appendChild(commandLine);

    // --- Command Parsing ---
    const { cmd, args } = parseCommand(fullCommand);

    if (!cmd) {
     scrollToBottom();
     return; // Do nothing if command is empty
    }

    // --- Handle 'clear' command locally ---
    if (cmd.toLowerCase() === 'clear') {
     historyDiv.innerHTML = '';
     // Re-add welcome message
     const welcomeMsg = document.createElement('p');
     welcomeMsg.className = 'welcome';
     welcomeMsg.textContent = "Welcome, Astronaut! Type 'help' to see available commands.";
     historyDiv.appendChild(welcomeMsg);
     scrollToBottom();
     return;
    }

    // --- Send to Backend ---
    try {
     const response = await fetch('/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cmd, args })
     });

     const data = await response.json();
     
     // Display the output
     const outputLine = document.createElement('pre');
     
     // Format output nicely based on the backend's response structure
     if (data.success && data.message) {
      outputLine.className = 'success';
      outputLine.textContent = data.message;
     } else if (!data.success && data.error) {
      outputLine.className = 'error';
      outputLine.textContent = `Error: ${data.error}`;
     } else {
      // Fallback
      outputLine.className = data.success ? 'success' : 'error';
      outputLine.textContent = data.success ? `Command '${cmd}' executed successfully.` : `Command '${cmd}' failed. Check server logs.`;
     }

     historyDiv.appendChild(outputLine);

    } catch (error) {
     const errorLine = document.createElement('pre');
     errorLine.className = 'error';
     errorLine.textContent = `A network error occurred: ${error.message}`;
     historyDiv.appendChild(errorLine);
    }
    
    scrollToBottom();
   }
  });

  function scrollToBottom() {
   terminalWindow.scrollTop = terminalWindow.scrollHeight;
   input.focus(); // Re-focus after history update
  }

  // Handle clicks outside the input to re-focus it
  terminalWindow.addEventListener('click', () => input.focus());
 </script>
</body>
</html>